<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SmartAnchor Demo | 固定ヘッダ対応アンカー補正</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --header-h: 72px;
        }
        body {
            padding-top: var(--header-h);
        }
        pre {
            background: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .demo-box {
            border: 2px dashed #dee2e6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }
    </style>

    <!-- SmartAnchor config (drop-in) -->
    <script>
        window.SMARTANCHOR_CONFIG = {
            offset: 72,
            autoInit: true
        };
    </script>

    <!-- SmartAnchor (demo assumes docs/demo.html, library at ../smartanchor.js) -->
    <script src="../smartanchor.js" defer></script>
</head>

<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm" style="min-height: var(--header-h);">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <span>SmartAnchor Demo</span>
                <span class="badge rounded-pill bg-light text-primary d-none d-sm-inline-block" style="font-size: 0.7rem;">Fixed Header: 72px</span>
                <span class="badge rounded-pill bg-info text-white" id="pill-mode" style="font-size: 0.7rem;">Mode: SmartAnchor ON</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://monou.jp" target="_blank" rel="noopener">制作: 門王</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container my-5">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-5 fw-bold">SmartAnchor 紹介 & 動作デモ</h1>
            <p class="text-muted">右の UI で ON/OFF や offset を変えて挙動を比較できます。</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7 order-lg-1 order-2">
            <nav class="card shadow-sm mb-4" aria-label="目次">
                <div class="card-body">
                    <h2 class="card-title h4 border-bottom pb-2 mb-3">目次（クリックしてデモ）</h2>
                    <p class="text-muted small">OFF にすると「見出しがヘッダに隠れる」問題が再現されます。</p>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item border-0 px-0 py-1"><a href="#what" class="text-decoration-none">SmartAnchorとは</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#problem" class="text-decoration-none">なぜ問題が起きるのか</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#try" class="text-decoration-none">ON/OFF UI（使い方）</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#usage" class="text-decoration-none">導入方法（初心者向け）</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#options" class="text-decoration-none">設定一覧（制作会社向け）</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#csp" class="text-decoration-none">CSP・広告・設定による注意点</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#troubleshooting" class="text-decoration-none">動かない時のチェック</a></li>
                        <li class="list-group-item border-0 px-0 py-1"><a href="#about-monou" class="text-decoration-none">制作：門王（依頼受付）</a></li>
                    </ul>

                    <div class="demo-box bg-light">
                        <strong class="d-block mb-2 text-primary">クイックテスト</strong>
                        <p class="text-muted small mb-2">このリンクは SmartAnchor を無効化します（常に通常ジャンプ）。</p>
                        <a href="#problem" data-smartanchor-ignore class="btn btn-sm btn-outline-secondary">data-smartanchor-ignore（通常ジャンプ）</a>
                    </div>
                </div>
            </nav>

            <section id="what" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">SmartAnchorとは</h2>
                <p>
                    固定ヘッダ（<code>position: fixed / sticky</code>）が原因で発生するアンカーリンクのズレを、
                    既存サイトに後付けで一括解決する軽量スクリプトです。
                </p>
            </section>

            <section id="problem" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">なぜ問題が起きるのか（fixed header 問題）</h2>
                <p>
                    ブラウザ標準の <code>#anchor</code> ジャンプは「対象要素の上端を viewport 上端に合わせる」動作です。
                    固定ヘッダがあると viewport 上端が覆われるため、見出しが隠れます。
                </p>
            </section>

            <section id="try" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">ON/OFF UI（使い方）</h2>
                <ol class="list-group list-group-numbered list-group-flush">
                    <li class="list-group-item border-0">右の Mode を OFF にする</li>
                    <li class="list-group-item border-0">目次リンクをクリックして「隠れる」問題を確認</li>
                    <li class="list-group-item border-0">Mode を ON に戻して補正を確認</li>
                    <li class="list-group-item border-0">offset をサイトのヘッダ高さに合わせる</li>
                </ol>
            </section>

            <section id="usage" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">導入方法（初心者向け）</h2>
                <pre>&lt;script&gt;
  window.SMARTANCHOR_CONFIG = { offset: 72, autoInit: true };
&lt;/script&gt;
&lt;script src="/assets/js/smartanchor.js" defer&gt;&lt;/script&gt;</pre>
            </section>

            <section id="options" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">設定一覧（制作会社向け）</h2>
                <div class="table-responsive border shadow-sm">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr><th>option</th><th>type</th><th>説明</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>offset</td><td>number</td><td>固定ヘッダの高さ</td></tr>
                            <tr><td>animate</td><td>boolean</td><td>スクロールアニメ</td></tr>
                            <tr><td>duration</td><td>number</td><td>アニメ時間（ms）</td></tr>
                            <tr><td>easing</td><td>string</td><td>linear / easeOut / easeInOut</td></tr>
                            <tr><td>updateHash</td><td>boolean</td><td>URLハッシュ更新</td></tr>
                            <tr><td>historyMode</td><td>string</td><td>push / replace</td></tr>
                            <tr><td>focus</td><td>boolean</td><td>a11y focus</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="csp" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">CSP・広告・設定による注意点</h2>

                <h3 class="h5 mt-4">CSP</h3>
                <p class="text-muted small">
                    外部JSを禁止している場合、smartanchor.js 自体が読み込めません。推奨は自サイト配信（'self'）です。
                </p>

                <h3 class="h5 mt-4">広告ブロッカー</h3>
                <p class="text-muted small">
                    CDN配信のJSがブロックされることがあります。自サイト配信が安全です。
                </p>

                <h3 class="h5 mt-4">WordPress最適化/キャッシュ</h3>
                <p class="text-muted small">
                    結合や遅延で実行順が変わると設定が効かないことがあります。smartanchor.js を除外するのが安全です。
                </p>
            </section>

            <section id="troubleshooting" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">動かない時のチェック</h2>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item border-0"><span class="badge bg-danger me-2">1</span> smartanchor.js のパスが正しいか</li>
                    <li class="list-group-item border-0"><span class="badge bg-danger me-2">2</span> SMARTANCHOR_CONFIG が先に定義されているか</li>
                    <li class="list-group-item border-0"><span class="badge bg-danger me-2">3</span> offset が実ヘッダ高さと合っているか</li>
                    <li class="list-group-item border-0"><span class="badge bg-danger me-2">4</span> 最適化/キャッシュで順序が変わっていないか</li>
                </ul>
            </section>

            <section id="about-monou" class="mb-5">
                <h2 class="h3 border-bottom pb-2 mb-3">制作：門王（依頼受付）</h2>
                <p>
                    SmartAnchor は <a href="https://monou.jp" target="_blank" rel="noopener" class="text-primary text-decoration-none fw-bold">門王（monou.jp）</a> が制作しています。
                    既存サイト向けの軽量スクリプト開発や、WordPress/静的サイトの改善などのご依頼を受け付けています。
                </p>
            </section>
        </div>

        <aside class="col-lg-5 order-lg-2 order-1">
            <div class="card shadow-sm sticky-lg-top" style="top: calc(var(--header-h) + 1rem); z-index: 100;">
                <div class="card-body">
                    <h2 class="card-title h4 border-bottom pb-2 mb-3">ON/OFF・設定 UI</h2>
                    <p class="text-muted small">このUIはデモ用です。本番には不要です。</p>

                    <div class="alert alert-info py-2 px-3 small mb-3">
                        <div class="fw-bold">状態: <span id="statusText">SmartAnchor ON</span></div>
                        <div id="statusConfig" class="text-muted" style="font-size: 0.75rem;"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Mode</label>
                            <select id="modeSelect" class="form-select form-select-sm">
                                <option value="on" selected>ON（補正あり）</option>
                                <option value="off">OFF（通常ジャンプ）</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">offset（px）</label>
                            <input id="offsetInput" type="number" class="form-select form-select-sm" min="0" step="1" value="72" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">animate</label>
                            <select id="animateSelect" class="form-select form-select-sm">
                                <option value="true" selected>true</option>
                                <option value="false">false</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">duration（ms）</label>
                            <input id="durationInput" type="number" class="form-select form-select-sm" min="0" step="10" value="280" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">easing</label>
                            <select id="easingSelect" class="form-select form-select-sm">
                                <option value="easeOut" selected>easeOut</option>
                                <option value="easeInOut">easeInOut</option>
                                <option value="linear">linear</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">updateHash</label>
                            <select id="updateHashSelect" class="form-select form-select-sm">
                                <option value="true" selected>true</option>
                                <option value="false">false</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">historyMode</label>
                            <select id="historyModeSelect" class="form-select form-select-sm">
                                <option value="push" selected>push</option>
                                <option value="replace">replace</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">focus</label>
                            <select id="focusSelect" class="form-select form-select-sm">
                                <option value="true" selected>true</option>
                                <option value="false">false</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button id="applyBtn" class="btn btn-primary btn-sm fw-bold">設定を適用</button>
                        <div class="btn-group">
                            <button id="resetBtn" class="btn btn-outline-secondary btn-sm">初期値に戻す</button>
                            <button id="copyBtn" class="btn btn-outline-secondary btn-sm">コピー</button>
                        </div>
                    </div>

                    <div id="copyHint" class="alert alert-success py-1 px-2 mt-2 small" style="display:none;">
                        コピーしました
                    </div>

                    <div class="mt-4">
                        <label class="form-label small fw-bold text-primary">生成されたスニペット</label>
                        <pre id="snippetBox" class="mb-0" style="max-height: 200px; overflow-y: auto;"></pre>
                    </div>

                    <div class="alert alert-warning py-2 px-3 small mt-3 mb-0">
                        <strong>注意:</strong> OFF は検証用です。
                    </div>
                </div>
            </div>
        </aside>
    </div>
</main>

<footer class="bg-light py-5 mt-5 border-top">
    <div class="container text-center">
        <p class="text-muted small mb-0">SmartAnchor Demo Page / &copy; monou.jp</p>
    </div>
</footer>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function () {
        'use strict';

        var state = {
            mode: 'on',
            cfg: {
                offset: 72,
                animate: true,
                duration: 280,
                easing: 'easeOut',
                updateHash: true,
                historyMode: 'push',
                focus: true
            }
        };

        var elMode = document.getElementById('modeSelect');
        var elOffset = document.getElementById('offsetInput');
        var elAnimate = document.getElementById('animateSelect');
        var elDuration = document.getElementById('durationInput');
        var elEasing = document.getElementById('easingSelect');
        var elUpdateHash = document.getElementById('updateHashSelect');
        var elHistoryMode = document.getElementById('historyModeSelect');
        var elFocus = document.getElementById('focusSelect');

        var elApply = document.getElementById('applyBtn');
        var elReset = document.getElementById('resetBtn');
        var elCopy = document.getElementById('copyBtn');

        var elStatusText = document.getElementById('statusText');
        var elStatusConfig = document.getElementById('statusConfig');
        var elSnippet = document.getElementById('snippetBox');
        var elCopyHint = document.getElementById('copyHint');
        var elPill = document.getElementById('pill-mode');

        function toBool(v) { return String(v) === 'true'; }
        function num(v, fallback) {
            var n = parseInt(v, 10);
            return isNaN(n) ? fallback : n;
        }

        function formatConfig(cfg) {
            return 'offset=' + cfg.offset +
                ', animate=' + cfg.animate +
                ', duration=' + cfg.duration +
                ', easing=' + cfg.easing +
                ', updateHash=' + cfg.updateHash +
                ', historyMode=' + cfg.historyMode +
                ', focus=' + cfg.focus;
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // Safer: snippet does not contain literal <script> tags in this JS block.
        // We output an HTML-escaped snippet for copy/paste display.
        function buildSnippetEscaped(cfg) {
            var snippet = ''
                + '<script>\n'
                + '  window.SMARTANCHOR_CONFIG = {\n'
                + '    offset: ' + cfg.offset + ',\n'
                + '    animate: ' + (cfg.animate ? 'true' : 'false') + ',\n'
                + '    duration: ' + cfg.duration + ',\n'
                + '    easing: "' + cfg.easing + '",\n'
                + '    updateHash: ' + (cfg.updateHash ? 'true' : 'false') + ',\n'
                + '    historyMode: "' + cfg.historyMode + '",\n'
                + '    focus: ' + (cfg.focus ? 'true' : 'false') + ',\n'
                + '    autoInit: true\n'
                + '  };\n'
                + '<\/script>\n'
                + '<script src="smartanchor.js" defer><\/script>\n';

            return escapeHtml(snippet);
        }

function setStatus() {
var on = (state.mode === 'on');
elStatusText.textContent = on ? 'SmartAnchor ON' : 'SmartAnchor OFF（通常ジャンプ）';
elStatusConfig.textContent = formatConfig(state.cfg);
elSnippet.innerHTML = buildSnippetEscaped(state.cfg);
elPill.textContent = 'Mode: ' + (on ? 'SmartAnchor ON' : 'SmartAnchor OFF');
}

function applyToSmartAnchor(cfg) {
window.SMARTANCHOR_CONFIG = window.SMARTANCHOR_CONFIG || {};
window.SMARTANCHOR_CONFIG.offset = cfg.offset;
window.SMARTANCHOR_CONFIG.animate = cfg.animate;
window.SMARTANCHOR_CONFIG.duration = cfg.duration;
window.SMARTANCHOR_CONFIG.easing = cfg.easing;
window.SMARTANCHOR_CONFIG.updateHash = cfg.updateHash;
window.SMARTANCHOR_CONFIG.historyMode = cfg.historyMode;
window.SMARTANCHOR_CONFIG.focus = cfg.focus;
window.SMARTANCHOR_CONFIG.autoInit = true;
}

function readUIIntoState() {
state.mode = elMode.value;
state.cfg.offset = num(elOffset.value, 72);
state.cfg.animate = toBool(elAnimate.value);
state.cfg.duration = num(elDuration.value, 280);
state.cfg.easing = elEasing.value;
state.cfg.updateHash = toBool(elUpdateHash.value);
state.cfg.historyMode = elHistoryMode.value;
state.cfg.focus = toBool(elFocus.value);
}

// OFF mode: force "native-like" behavior (no offset)
function nativeAnchorHandler(e) {
if (state.mode !== 'off') return;

if (e.defaultPrevented) return;
if (e.button != null && e.button !== 0) return;
if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

var t = e.target;
while (t && t !== document) {
if (t.tagName && t.tagName.toLowerCase() === 'a') break;
t = t.parentNode;
}
if (!t || t === document) return;

var href = t.getAttribute('href') || '';
if (!href || href === '#' || href.charAt(0) !== '#') return;

if (e.preventDefault) e.preventDefault();

try { window.location.hash = href; } catch (ex) {}

var id = href.slice(1);
try { id = decodeURIComponent(id); } catch (ex2) {}
var target = document.getElementById(id) || (document.getElementsByName(id)[0]);
if (target && target.scrollIntoView) {
try { target.scrollIntoView(); } catch (ex3) {}
}
}

document.addEventListener('click', nativeAnchorHandler, false);

elApply.addEventListener('click', function () {
readUIIntoState();
applyToSmartAnchor(state.cfg);
setStatus();
});

elReset.addEventListener('click', function () {
elMode.value = 'on';
elOffset.value = 72;
elAnimate.value = 'true';
elDuration.value = 280;
elEasing.value = 'easeOut';
elUpdateHash.value = 'true';
elHistoryMode.value = 'push';
elFocus.value = 'true';

readUIIntoState();
applyToSmartAnchor(state.cfg);
setStatus();
});

elCopy.addEventListener('click', function () {
elCopyHint.style.display = 'none';

            // Copy the real (non-escaped) snippet
            var raw = ''
                + '<script>\n'
                + '  window.SMARTANCHOR_CONFIG = {\n'
                + '    offset: ' + state.cfg.offset + ',\n'
                + '    animate: ' + (state.cfg.animate ? 'true' : 'false') + ',\n'
                + '    duration: ' + state.cfg.duration + ',\n'
                + '    easing: "' + state.cfg.easing + '",\n'
                + '    updateHash: ' + (state.cfg.updateHash ? 'true' : 'false') + ',\n'
                + '    historyMode: "' + state.cfg.historyMode + '",\n'
                + '    focus: ' + (state.cfg.focus ? 'true' : 'false') + ',\n'
                + '    autoInit: true\n'
                + '  };\n'
                + '<\/script>\n'
                + '<script src="smartanchor.js" defer><\/script>\n';

if (navigator.clipboard && navigator.clipboard.writeText) {
navigator.clipboard.writeText(raw).then(function () {
elCopyHint.style.display = 'block';
setTimeout(function () { elCopyHint.style.display = 'none'; }, 1800);
}, function () {
elCopyHint.style.display = 'block';
setTimeout(function () { elCopyHint.style.display = 'none'; }, 2200);
});
} else {
elCopyHint.style.display = 'block';
setTimeout(function () { elCopyHint.style.display = 'none'; }, 2200);
}
});

// Init
readUIIntoState();
applyToSmartAnchor(state.cfg);
setStatus();

})();
</script>

</body>
</html>
